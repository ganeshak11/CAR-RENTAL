<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Verify Documents - FlexiCarz</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <header class="navbar">
    <div class="container">
      <div class="navbar-content">
        <div class="logo">
          <span>FlexiCarz</span>
        </div>
        <button class="hamburger-menu" id="hamburgerBtn" aria-label="Toggle menu">
          <span class="hamburger-line"></span>
          <span class="hamburger-line"></span>
          <span class="hamburger-line"></span>
        </button>
        <div class="nav-actions" id="navActions">
          <a href="index.html" class="btn btn-secondary">Back to Home</a>
          <button id="logoutBtn" class="btn-logout">Logout</button>
        </div>
      </div>
    </div>
  </header>

  <main class="verify-main">
    <div class="container">
      <div class="verify-header">
        <h1>Document Verification</h1>
        <p>Upload your driving license to complete verification and proceed with bookings</p>
      </div>

      <div class="verify-card">
        <form id="verifyForm" class="verify-form">
          <div class="document-section">
            <h3>üìÑ Required Document</h3>
            
            <div class="doc-item">
              <label>Driving License</label>
              <input type="file" id="drivingLicense" accept="image/*,.pdf" required>
              <small>Upload clear photo of your driving license</small>
            </div>
          </div>

          <div class="verification-status" id="verificationStatus">
            <div class="status-item">
              <span class="status-label">Verification Status:</span>
              <span id="statusText" class="status-pending">Pending</span>
            </div>
          </div>

          <button type="submit" class="btn btn-primary btn-full">
            Submit for Verification
          </button>

          <button type="button" id="refreshBtn" class="btn btn-secondary btn-full" style="margin-top: 10px;">
            Refresh Status
          </button>

          <div id="verifyMsg" class="message"></div>
        </form>
      </div>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
  <script src="supabase.js"></script>
  <script>
    // Initialize EmailJS - Replace with your public key from https://dashboard.emailjs.com/admin/account
    emailjs.init('rfTetd0QB_FpxrikB');
    
    // Function to send admin notification email
    async function sendAdminNotification(userData, documentUrl) {
      try {
        const templateParams = {
          user_name: userData.full_name || userData.email.split('@')[0],
          user_email: userData.email,
          document_url: documentUrl,
          submission_date: new Date().toLocaleString(),
          admin_panel_link: window.location.origin + '/admin-documents.html'
        };
        
        await emailjs.send(
          'service_vluz4yn',    // Replace with your EmailJS service ID
          'template_mnehgnr',   // Replace with your EmailJS template ID
          templateParams
        );
        
        console.log('‚úÖ Admin notification sent successfully');
      } catch (error) {
        console.error('‚ùå Failed to send admin notification:', error);
      }
    }
  </script>
  <script>
    if (!isAuthenticated()) {
      window.location.href = 'login.html';
    }

    async function checkVerificationStatus() {
      try {
        const { data: { user } } = await window.supabase.auth.getUser();
        if (user) {
          // Check document status instead of user profile status
          const { data: documents, error } = await window.supabase
            .from('user_documents')
            .select('status')
            .eq('user_id', user.id)
            .order('created_at', { ascending: false })
            .limit(1);

          if (error) {
            console.error('Error fetching document status:', error);
            return;
          }

          const docStatus = documents?.[0]?.status || 'none';
          console.log('Document status from DB:', docStatus);
          
          // Map document status to verification status
          let status = 'pending';
          if (docStatus === 'approved') status = 'verified';
          else if (docStatus === 'pending') status = 'submitted';
          else if (docStatus === 'rejected') status = 'rejected';
          else if (docStatus === 'none') status = 'pending';
          
          const statusText = document.getElementById('statusText');
          
          if (statusText) {
            statusText.textContent = status.charAt(0).toUpperCase() + status.slice(1);
            statusText.className = `status-${status}`;
          }
          
          if (status === 'verified') {
            document.getElementById('verifyForm').innerHTML = `
              <div class="verified-message">
                <h3>‚úÖ Documents Verified</h3>
                <p>Your documents have been successfully verified. You can now proceed with bookings.</p>
                <a href="booking.html" class="btn btn-primary">Start Booking</a>
              </div>
            `;
          } else if (status === 'submitted') {
            const verifyForm = document.getElementById('verifyForm');
            if (verifyForm && verifyForm.querySelector('.pending-message') === null) {
              verifyForm.innerHTML = `
                <div class="pending-message">
                  <h3>‚è≥ Documents Under Review</h3>
                  <p>Your documents have been submitted and are currently being reviewed by our admin team.</p>
                  <button type="button" onclick="location.reload()" class="btn btn-secondary">Refresh Status</button>
                  <button type="button" onclick="location.reload()" class="btn btn-primary" style="margin-top: 10px;">Resubmit Documents</button>
                  <a href="index.html" class="btn btn-secondary" style="margin-top: 10px;">Back to Home</a>
                </div>
              `;
            }
          } else if (status === 'rejected') {
            const verifyForm = document.getElementById('verifyForm');
            if (verifyForm && verifyForm.querySelector('.rejected-message') === null) {
              verifyForm.innerHTML = `
                <div class="rejected-message">
                  <h3>‚ùå Documents Rejected</h3>
                  <p>Your documents were rejected. Please upload new documents for verification.</p>
                  <button type="button" onclick="location.reload()" class="btn btn-primary">Resubmit Documents</button>
                  <a href="index.html" class="btn btn-secondary" style="margin-top: 10px;">Back to Home</a>
                </div>
              `;
            }
          }
        }
      } catch (error) {
        console.error('Error checking verification status:', error);
      }
    }

    const verifyForm = document.getElementById('verifyForm');
    if (verifyForm) {
      verifyForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const drivingLicense = document.getElementById('drivingLicense').files[0];
        const msg = document.getElementById('verifyMsg');

        if (!drivingLicense) {
          msg.textContent = '‚ùå Please upload driving license';
          msg.className = 'message show error';
          return;
        }

        try {
          const user = getCurrentUser();
          if (!user) {
            msg.textContent = '‚ùå User not found';
            msg.className = 'message show error';
            return;
          }

          msg.textContent = 'Uploading document...';
          msg.className = 'message show';

          const fileName = `${user.id}/driving_license/${Date.now()}-${drivingLicense.name}`;
          const { data, error } = await window.supabase.storage
            .from('documents')
            .upload(fileName, drivingLicense);

          if (error) {
            msg.textContent = '‚ùå Error uploading document. Please try again.';
            msg.className = 'message show error';
            return;
          }

          const { error: insertError } = await window.supabase
            .from('user_documents')
            .insert({
              user_id: user.id,
              document_url: data.path,
              document_type: 'driving_license',
              status: 'pending'
            });

          if (insertError) {
            msg.textContent = '‚ùå Error saving document. Please try again.';
            msg.className = 'message show error';
            return;
          }

          const { error: updateError } = await window.supabase
            .from('user_profiles')
            .update({ 
              verification_status: 'submitted',
              documents_submitted_at: new Date().toISOString()
            })
            .eq('user_id', user.id);

          if (updateError) {
            msg.textContent = '‚ùå Error updating status. Please try again.';
            msg.className = 'message show error';
            return;
          }

          // Get signed URL for document
          const { data: urlData } = await window.supabase.storage
            .from('documents')
            .createSignedUrl(data.path, 604800); // 7 days
          
          // Get user profile for full name
          const { data: profile } = await window.supabase
            .from('user_profiles')
            .select('full_name')
            .eq('user_id', user.id)
            .single();
          
          // Send email notification to admin
          const userData = {
            email: user.email,
            full_name: profile?.full_name
          };
          await sendAdminNotification(userData, urlData?.signedUrl || '');

          msg.textContent = '‚úÖ Document submitted successfully! Admin has been notified.';
          msg.className = 'message show success';
          
          setTimeout(() => {
            checkVerificationStatus();
          }, 2000);
        } catch (error) {
          console.error('Error:', error);
          msg.textContent = '‚ùå Error uploading document. Please try again.';
          msg.className = 'message show error';
        }
      });
    }

    const refreshBtn = document.getElementById('refreshBtn');
    if (refreshBtn) {
      refreshBtn.addEventListener('click', (e) => {
        e.preventDefault();
        checkVerificationStatus();
      });
    }

    document.getElementById('logoutBtn').addEventListener('click', async () => {
      await window.supabase.auth.signOut();
      localStorage.removeItem('supabase_token');
      localStorage.removeItem('supabase_user');
      window.location.href = 'login.html';
    });

    checkVerificationStatus();
    setInterval(checkVerificationStatus, 5000);
  </script>
  
  <style>
    .verify-main {
      min-height: calc(100vh - 80px);
      padding: 40px 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .verify-header {
      text-align: center;
      color: white;
      margin-bottom: 40px;
    }

    .verify-header h1 {
      font-size: 2.5rem;
      margin-bottom: 10px;
    }

    .verify-card {
      background: white;
      border-radius: 12px;
      padding: 40px;
      max-width: 600px;
      margin: 0 auto;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
    }

    .document-section h3 {
      margin-bottom: 30px;
      color: #333;
      font-size: 1.3rem;
    }

    .doc-item {
      margin-bottom: 25px;
    }

    .doc-item label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #333;
    }

    .doc-item input[type="file"] {
      width: 100%;
      padding: 12px;
      border: 2px dashed #667eea;
      border-radius: 6px;
      cursor: pointer;
    }

    .doc-item small {
      display: block;
      margin-top: 5px;
      color: #666;
      font-size: 0.85rem;
    }

    .verification-status {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 6px;
      margin: 25px 0;
    }

    .status-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .status-label {
      font-weight: 600;
      color: #333;
    }

    .status-pending {
      color: #ffc107;
      font-weight: 600;
    }

    .status-submitted {
      color: #17a2b8;
      font-weight: 600;
    }

    .status-verified {
      color: #28a745;
      font-weight: 600;
    }

    .status-rejected {
      color: #dc3545;
      font-weight: 600;
    }

    .verified-message, .pending-message {
      text-align: center;
      padding: 40px 20px;
    }

    .verified-message h3, .pending-message h3 {
      margin-bottom: 15px;
      font-size: 1.5rem;
    }

    .verified-message p, .pending-message p {
      color: #666;
      margin-bottom: 20px;
      line-height: 1.6;
    }

    .btn-full {
      width: 100%;
    }

    .btn-secondary {
      background: #6c757d;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
    }

    .btn-secondary:hover {
      background: #5a6268;
    }
  </style>
</body>
</html>
