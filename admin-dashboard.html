<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Admin dashboard for FlexiCarz — manage cars, bookings, users and documents">
  <link rel="icon" href="favicon.ico">
  <title>Admin Dashboard - FlexiCarz</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <header class="navbar">
    <div class="container">
      <div class="navbar-content">
        <div class="logo">
          <span>FlexiCarz Admin</span>
        </div>
        <div class="nav-actions">
          <a href="admin-documents.html" class="btn-nav">Document Verification</a>
          <button id="adminLogoutBtn" class="btn-logout">Logout</button>
        </div>
      </div>
    </div>
  </header>

  <main class="admin-main">
    <div class="container">
      <h1>Admin Dashboard</h1>
      
      <div class="admin-tabs">
        <button class="tab-btn active" data-tab="dashboard">Dashboard</button>
        <button class="tab-btn" data-tab="bookings">All Bookings</button>
        <button class="tab-btn" data-tab="users">Users</button>
      </div>
      
      <!-- Dashboard Tab -->
      <div id="dashboard-tab" class="tab-content active">
        <div class="admin-stats">
          <div class="stat-card">
            <h3>Total Cars</h3>
            <p id="totalCars">0</p>
          </div>
          <div class="stat-card">
            <h3>Total Bookings</h3>
            <p id="totalBookings">0</p>
          </div>
          <div class="stat-card">
            <h3>Available Cars</h3>
            <p id="availableCars">0</p>
          </div>
          <div class="stat-card">
            <h3>Total Revenue</h3>
            <p id="totalRevenue">₹0</p>
          </div>
        </div>

        <section class="admin-section">
          <div class="section-header">
            <h2>Recent Bookings</h2>
            <button onclick="refreshDashboard()" class="btn btn-primary">Refresh</button>
          </div>
          <div id="recentBookingsList" class="bookings-list"></div>
        </section>
      </div>
      
      <!-- All Bookings Tab -->
      <div id="bookings-tab" class="tab-content">
        <div class="section-header">
          <h2>All Bookings</h2>
          <div class="filters">
            <select id="statusFilter">
              <option value="">All Status</option>
              <option value="pending">Pending</option>
              <option value="confirmed">Confirmed</option>
              <option value="completed">Completed</option>
              <option value="cancelled">Cancelled</option>
            </select>
            <button onclick="exportBookings()" class="btn btn-secondary">Export CSV</button>
          </div>
        </div>
        <div id="allBookingsList" class="bookings-list"></div>
      </div>
      
      <!-- Users Tab -->
      <div id="users-tab" class="tab-content">
        <div class="section-header">
          <h2>Registered Users</h2>
          <button onclick="refreshUsers()" class="btn btn-primary">Refresh</button>
        </div>
        <div id="usersList" class="users-list"></div>
      </div>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="supabase.js"></script>
  <script>
    let allBookings = [];
    let allUsers = [];

    function formatLocalDateTime(dateString) {
      return new Date(dateString).toLocaleString();
    }

    async function checkAdminAuth() {
      const { data: { user } } = await window.supabase.auth.getUser();
      if (!user || user.user_metadata?.role !== 'admin') {
        window.location.href = 'admin.html';
      }
    }
    checkAdminAuth();

    document.getElementById('adminLogoutBtn').addEventListener('click', async () => {
      await window.supabase.auth.signOut();
      window.location.href = 'admin.html';
    });

    async function loadDashboardData() {
      try {
        const { data: cars, error: carsError } = await window.supabase.from('cars').select('*');
        const { data: bookings, error: bookingsError } = await window.supabase.from('bookings').select('*');
        
        if (cars) {
          document.getElementById('totalCars').textContent = cars.length;
          // FIX: only count cars where is_available is true or 'true'
          const availableCount = cars.filter(
            c => c.is_available === true || c.is_available === 'true'
          ).length;
          document.getElementById('availableCars').textContent = availableCount;
        }
        
        if (bookings && bookings.length > 0) {
          allBookings = bookings;
          document.getElementById('totalBookings').textContent = bookings.length;
          
          const totalRevenue = bookings.reduce((sum, b) => sum + (b.total_amount || 0), 0);
          document.getElementById('totalRevenue').textContent = `₹${totalRevenue.toLocaleString()}`;
          
          loadRecentBookings(bookings);
        } else {
          document.getElementById('totalBookings').textContent = '0';
          document.getElementById('recentBookingsList').innerHTML = '<p>No bookings found</p>';
        }
      } catch (error) {
        console.error('Error loading dashboard data:', error);
      }
    }
    
    function loadRecentBookings(bookings) {
      const bookingsList = document.getElementById('recentBookingsList');
      if (!bookings || bookings.length === 0) {
        bookingsList.innerHTML = '<p>No bookings available</p>';
        return;
      }
      
      const recent = bookings.slice(-10).reverse();
      
      bookingsList.innerHTML = recent.map(booking => `
        <div class="booking-card">
          <div class="booking-header">
            <div class="booking-customer">
              <h4>${booking.customer_name}</h4>
              <p>${booking.customer_email}</p>
            </div>
            <span class="booking-status status-${booking.status}">${booking.status}</span>
          </div>
          <div class="booking-details">
            <div class="detail-row">
              <span class="label">Age:</span>
              <span class="value">${booking.customer_age} years</span>
            </div>
            <div class="detail-row">
              <span class="label">Dates:</span>
              <span class="value">${booking.start_date} to ${booking.end_date}</span>
            </div>
            <div class="detail-row">
              <span class="label">Duration:</span>
              <span class="value">${booking.total_days} days</span>
            </div>
            <div class="detail-row">
              <span class="label">Amount:</span>
              <span class="value amount">₹${booking.total_amount.toLocaleString()}</span>
            </div>
            <div class="detail-row">
              <span class="label">Booked:</span>
              <span class="value">${formatLocalDateTime(booking.created_at)}</span>
            </div>
          </div>
          <div class="booking-actions">
            <select onchange="updateBookingStatus('${booking.id}', this.value)" class="status-select">
              <option value="pending"   ${booking.status === 'pending' ? 'selected' : ''}>Pending</option>
              <option value="confirmed" ${booking.status === 'confirmed' ? 'selected' : ''}>Confirmed</option>
              <option value="completed" ${booking.status === 'completed' ? 'selected' : ''}>Completed</option>
              <option value="cancelled" ${booking.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
            </select>
            ${booking.status === 'confirmed' ? `<button onclick="completeBooking('${booking.id}')" class="btn btn-success btn-sm">Return Car</button>` : ''}
            <button onclick="deleteBooking('${booking.id}')" class="btn btn-danger btn-sm">Delete</button>
          </div>
        </div>
      `).join('');
    }

    window.showTab = (tabName) => {
      document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
      document.getElementById(tabName + '-tab').classList.add('active');
      document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
      
      if (tabName === 'bookings') loadAllBookings();
      if (tabName === 'users') loadAllUsers();
    };
    
    async function loadAllBookings() {
      const { data: bookings, error } = await window.supabase.from('bookings').select('*');
      
      if (!bookings || bookings.length === 0) {
        document.getElementById('allBookingsList').innerHTML = '<p>No bookings found</p>';
        return;
      }
      
      allBookings = bookings;
      const statusFilter = document.getElementById('statusFilter').value;
      const filtered = statusFilter ? bookings.filter(b => b.status === statusFilter) : bookings;
      
      const bookingsList = document.getElementById('allBookingsList');
      bookingsList.innerHTML = filtered.map(booking => `
        <div class="booking-card">
          <div class="booking-header">
            <div class="booking-customer">
              <h4>${booking.customer_name}</h4>
              <p>${booking.customer_email}</p>
            </div>
            <span class="booking-status status-${booking.status}">${booking.status}</span>
          </div>
          <div class="booking-details">
            <div class="detail-row">
              <span class="label">Age:</span>
              <span class="value">${booking.customer_age} years</span>
            </div>
            <div class="detail-row">
              <span class="label">Dates:</span>
              <span class="value">${booking.start_date} to ${booking.end_date}</span>
            </div>
            <div class="detail-row">
              <span class="label">Duration:</span>
              <span class="value">${booking.total_days} days</span>
            </div>
            <div class="detail-row">
              <span class="label">Amount:</span>
              <span class="value amount">₹${booking.total_amount.toLocaleString()}</span>
            </div>
            <div class="detail-row">
              <span class="label">Booked:</span>
              <span class="value">${formatLocalDateTime(booking.created_at)}</span>
            </div>
          </div>
          <div class="booking-actions">
            <select onchange="updateBookingStatus('${booking.id}', this.value)" class="status-select">
              <option value="pending"   ${booking.status === 'pending' ? 'selected' : ''}>Pending</option>
              <option value="confirmed" ${booking.status === 'confirmed' ? 'selected' : ''}>Confirmed</option>
              <option value="completed" ${booking.status === 'completed' ? 'selected' : ''}>Completed</option>
              <option value="cancelled" ${booking.status === 'cancelled' ? 'selected' : ''}>Cancelled</option>
            </select>
            ${booking.status === 'confirmed' ? `<button onclick="completeBooking('${booking.id}')" class="btn btn-success btn-sm">Return Car</button>` : ''}
            <button onclick="deleteBooking('${booking.id}')" class="btn btn-danger btn-sm">Delete</button>
          </div>
        </div>
      `).join('');
    }
    
    // ---------- STATUS CHANGE ALSO UPDATES CAR AVAILABILITY ----------
    window.updateBookingStatus = async (bookingId, status) => {
      try {
        // Find booking to get car_id
        const booking = allBookings.find(b => String(b.id) === String(bookingId));

        await window.supabase
          .from('bookings')
          .update({ status })
          .eq('id', bookingId);

        // If we know the car, sync is_available with status
        if (booking && booking.car_id) {
          if (status === 'confirmed') {
            // Car is blocked
            await window.supabase
              .from('cars')
              .update({ is_available: false })
              .eq('id', booking.car_id);
          } else if (status === 'completed' || status === 'cancelled' || status === 'pending') {
            // Car is free again
            await window.supabase
              .from('cars')
              .update({ is_available: true })
              .eq('id', booking.car_id);
          }
        }

        await loadAllBookings();
        await loadDashboardData();
      } catch (err) {
        console.error('Error updating status:', err);
        alert('❌ Error updating booking status');
      }
    };

    window.completeBooking = async (bookingId) => {
      if (!confirm('Mark car as returned?')) return;
      try {
        const { data: booking, error: bookingError } = await window.supabase
          .from('bookings')
          .select('car_id')
          .eq('id', bookingId)
          .single();

        if (bookingError) {
          console.error('Booking fetch error:', bookingError);
          throw bookingError;
        }

        const { error: statusError } = await window.supabase
          .from('bookings')
          .update({ status: 'completed' })
          .eq('id', bookingId);

        if (statusError) {
          console.error('Status update error:', statusError);
          throw statusError;
        }

        const { error: carError } = await window.supabase
          .from('cars')
          .update({ is_available: true })
          .eq('id', booking.car_id);

        if (carError) {
          console.error('Car update error:', carError);
          throw carError;
        }

        alert('✅ Car returned successfully!');
        loadAllBookings();
        loadDashboardData();
      } catch (error) {
        console.error('Error returning car:', error);
        alert('❌ Error: ' + error.message);
      }
    };

    window.deleteBooking = async (bookingId) => {
      if (!confirm('Delete this booking?')) return;
      try {
        const { error } = await window.supabase.from('bookings').delete().eq('id', bookingId);
        if (error) {
          console.error('Delete error:', error);
          alert('❌ Error deleting booking: ' + error.message);
          return;
        }
        alert('✅ Booking deleted successfully!');
        loadAllBookings();
        loadDashboardData();
      } catch (error) {
        console.error('Delete error:', error);
        alert('❌ Error: ' + error.message);
      }
    };
    
    async function loadAllUsers() {
      const { data: users } = await window.supabase.from('user_profiles').select('*');
      allUsers = users || [];
      
      const usersList = document.getElementById('usersList');
      if (!users || users.length === 0) {
        usersList.innerHTML = '<p>No users found</p>';
        return;
      }
      
      usersList.innerHTML = users.map(user => `
        <div class="user-card">
          <div class="user-header">
            <h4>${user.full_name}</h4>
            <span class="verification-badge status-${user.verification_status}">${user.verification_status}</span>
          </div>
          <div class="user-details">
            <div class="detail-row">
              <span class="label">Phone:</span>
              <span class="value">${user.phone || 'N/A'}</span>
            </div>
            <div class="detail-row">
              <span class="label">Role:</span>
              <span class="value">${user.role}</span>
            </div>
            <div class="detail-row">
              <span class="label">Joined:</span>
              <span class="value">${formatLocalDateTime(user.created_at)}</span>
            </div>
            ${user.verified_at ? `
              <div class="detail-row">
                <span class="label">Verified:</span>
                <span class="value">${formatLocalDateTime(user.verified_at)}</span>
              </div>
            ` : ''}
          </div>
          <div class="user-actions">
            <button onclick="deleteUser('${user.user_id}')" class="btn btn-danger btn-sm">Delete User</button>
          </div>
        </div>
      `).join('');
    }

    window.deleteUser = async (userId) => {
      if (!confirm('Delete this user? This action cannot be undone.')) return;
      await window.supabase.from('user_profiles').delete().eq('user_id', userId);
      loadAllUsers();
    };

    window.refreshDashboard = () => {
      loadDashboardData();
    };

    window.refreshUsers = () => {
      loadAllUsers();
    };

    window.exportBookings = () => {
      const statusFilter = document.getElementById('statusFilter').value;
      const filtered = statusFilter ? allBookings.filter(b => b.status === statusFilter) : allBookings;
      
      if (filtered.length === 0) {
        alert('No bookings to export');
        return;
      }

      const headers = ['Customer Name', 'Email', 'Age', 'Start Date', 'End Date', 'Days', 'Amount', 'Status', 'Booked Date'];
      const rows = filtered.map(b => [
        b.customer_name || '',
        b.customer_email || '',
        b.customer_age || '',
        b.start_date || '',
        b.end_date || '',
        b.total_days || '',
        b.total_amount || '',
        b.status || '',
        new Date(b.created_at || '').toLocaleString()
      ]);

      const escapeCell = (cell) => {
        if (cell === null || cell === undefined) return '';
        const s = String(cell).replace(/"/g, '""');
        return `"${s}"`;
      };

      const csvContent = [headers, ...rows].map(r => r.map(escapeCell).join(',')).join('\n');

      const BOM = '\uFEFF';
      const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `bookings-${new Date().toISOString().split('T')[0]}.csv`;
      document.body.appendChild(a);
      a.click();
      a.remove();
    };

    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => showTab(btn.dataset.tab));
    });

    document.getElementById('statusFilter')?.addEventListener('change', () => {
      loadAllBookings();
    });

    loadDashboardData();
  </script>

  <style>
    .admin-main {
      min-height: calc(100vh - 80px);
      padding: 40px 0;
      background: #f5f5f5;
    }

    .admin-main h1 {
      margin-bottom: 30px;
      color: #333;
    }

    .admin-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 30px;
      border-bottom: 2px solid #ddd;
    }

    .tab-btn {
      padding: 12px 20px;
      background: none;
      border: none;
      cursor: pointer;
      font-size: 1rem;
      color: #666;
      border-bottom: 3px solid transparent;
      transition: all 0.3s;
    }

    .tab-btn.active {
      color: #0b6efd;
      border-bottom-color: #0b6efd;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .admin-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 40px;
    }

    .stat-card {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      text-align: center;
    }

    .stat-card h3 {
      margin: 0 0 10px 0;
      color: #666;
      font-size: 0.9rem;
      text-transform: uppercase;
    }

    .stat-card p {
      margin: 0;
      font-size: 2rem;
      color: #0b6efd;
      font-weight: bold;
    }

    .admin-section {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      flex-wrap: wrap;
      gap: 15px;
    }

    .section-header h2 {
      margin: 0;
      color: #333;
    }

    .filters {
      display: flex;
      gap: 10px;
    }

    .filters select {
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 0.9rem;
    }

    .bookings-list, .users-list {
      display: grid;
      gap: 20px;
    }

    .booking-card, .user-card {
      background: white;
      border: 1px solid #eee;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.05);
    }

    .booking-header, .user-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 15px;
      padding-bottom: 15px;
      border-bottom: 1px solid #eee;
    }

    .booking-customer h4, .user-header h4 {
      margin: 0 0 5px 0;
      color: #333;
    }

    .booking-customer p {
      margin: 0;
      color: #666;
      font-size: 0.9rem;
    }

    .booking-status, .verification-badge {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
    }

    .status-pending {
      background: #fff3cd;
      color: #856404;
    }

    .status-confirmed {
      background: #d1ecf1;
      color: #0c5460;
    }

    .status-completed {
      background: #d4edda;
      color: #155724;
    }

    .status-cancelled {
      background: #f8d7da;
      color: #721c24;
    }

    .status-verified {
      background: #d4edda;
      color: #155724;
    }

    .status-submitted {
      background: #d1ecf1;
      color: #0c5460;
    }

    .booking-details, .user-details {
      margin-bottom: 15px;
    }

    .detail-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #f0f0f0;
    }

    .detail-row:last-child {
      border-bottom: none;
    }

    .label {
      color: #666;
      font-weight: 500;
    }

    .value {
      color: #333;
      font-weight: 500;
    }

    .value.amount {
      color: #0b6efd;
      font-weight: bold;
    }

    .booking-actions, .user-actions {
      display: flex;
      gap: 10px;
    }

    .status-select {
      flex: 1;
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 0.9rem;
      cursor: pointer;
    }

    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: all 0.3s;
    }

    .btn-primary {
      background: #0b6efd;
      color: white;
    }

    .btn-primary:hover {
      background: #0a58ca;
    }

    .btn-secondary {
      background: #6c757d;
      color: white;
    }

    .btn-secondary:hover {
      background: #5c636a;
    }

    .btn-success {
      background: #28a745;
      color: white;
    }

    .btn-success:hover {
      background: #218838;
    }

    .btn-danger {
      background: #dc3545;
      color: white;
    }

    .btn-danger:hover {
      background: #bb2d3b;
    }

    .btn-sm {
      padding: 6px 12px;
      font-size: 0.85rem;
    }
  </style>
</body>
</html>
